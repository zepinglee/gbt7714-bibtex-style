%
% Copyright (c) 2016-2025 Zeping Lee
% Released under the LaTeX Project Public License v1.3c or later versions.
% Repository: https://github.com/zepinglee/gbt7714-bibtex-style
%

\NeedsTeXFormat{LaTeX2e}

\RequirePackage{expl3}
\ProvidesPackage{gbt7714}[2025/06/22 v2.1.8 GB/T 7714 BibTeX Style]

% 兼容过时的接口
\newif\ifgbt@legacy@interface
\newif\ifgbt@mmxv
\newif\ifgbt@numerical
\newif\ifgbt@super
\newcommand\gbt@obsolete@option[1]{%
  \PackageWarning{gbt7714}{The option "#1" is obsolete}%
}
\DeclareKeys[gbt7714]{
  2015 .code = {%
    \gbt@obsolete@option{2015}%
    \gbt@legacy@interfacetrue
    \gbt@mmxvtrue
  },
  2005 .code = {%
    \gbt@obsolete@option{2005}%
    \gbt@legacy@interfacetrue
    \gbt@mmxvfalse
  },
  super .code = {%
    \gbt@obsolete@option{super}%
    \gbt@legacy@interfacetrue
    \gbt@numericaltrue
    \gbt@supertrue
  },
  numbers .code = {%
    \gbt@obsolete@option{numbers}%
    \gbt@legacy@interfacetrue
    \gbt@numericaltrue
    \gbt@superfalse
  },
  authoryear .code = {%
    \gbt@obsolete@option{authoryear}%
    \gbt@legacy@interfacetrue
    \gbt@numericalfalse
  },
}

% 控制 bst 的格式。
\ExplSyntaxOn

\prop_new:N \l__gbt_bst_control_prop

\keys_define:nn { gbt7714 }
  {
    maxbibnames .code:n =
      { \prop_put:Nne \l__gbt_bst_control_prop { CTL_max_bib_names } {#1} } ,
    minbibnames .code:n =
      { \prop_put:Nne \l__gbt_bst_control_prop { CTL_min_bib_names } {#1} } ,
    maxcitenames .code:n =
      { \prop_put:Nne \l__gbt_bst_control_prop { CTL_max_cite_names } {#1} } ,
    mincitenames .code:n =
      { \prop_put:Nne \l__gbt_bst_control_prop { CTL_min_cite_names } {#1} } ,
    familyuppercase .choices:nn = { true, false }
      { \prop_put:NnV \l__gbt_bst_control_prop { CTL_family_uppercase } \l_keys_choice_tl } ,
    citelang .choices:nn = { auto, macro, chinese, english }
      { \prop_put:NnV \l__gbt_bst_control_prop { CTL_cite_lang } \l_keys_choice_tl } ,
    yearbeforetitle .choices:nn = { true, false }
      { \prop_put:NnV \l__gbt_bst_control_prop { CTL_year_before_title } \l_keys_choice_tl } ,
    nameyeardelim .choices:nn = { comma , period }
      { \prop_put:NnV \l__gbt_bst_control_prop { CTL_name_year_delim } \l_keys_choice_tl } ,
    italicbooktitle .choices:nn = { true, false }
      { \prop_put:NnV \l__gbt_bst_control_prop { CTL_italic_book_title } \l_keys_choice_tl } ,
    sentence-case .choices:nn = { true, false }
      {
        \prop_put:NnV \l__gbt_bst_control_prop { CTL_sentence_case_title } \l_keys_choice_tl
        \prop_put:NnV \l__gbt_bst_control_prop { CTL_sentence_case_journal } \l_keys_choice_tl
        \prop_put:NnV \l__gbt_bst_control_prop { CTL_sentence_case_booktitle } \l_keys_choice_tl
      } ,
    sentence-case-title .choices:nn = { true, false }
      { \prop_put:NnV \l__gbt_bst_control_prop { CTL_sentence_case_title } \l_keys_choice_tl } ,
    sentence-case-journal .choices:nn = { true, false }
      { \prop_put:NnV \l__gbt_bst_control_prop { CTL_sentence_case_journal } \l_keys_choice_tl } ,
    sentence-case-booktitle .choices:nn = { true, false }
      { \prop_put:NnV \l__gbt_bst_control_prop { CTL_sentence_case_booktitle } \l_keys_choice_tl } ,
    articletitle .choices:nn = { true, false }
      { \prop_put:NnV \l__gbt_bst_control_prop { CTL_article_title } \l_keys_choice_tl } ,
    patentcountry .choices:nn = { true, false }
      { \prop_put:NnV \l__gbt_bst_control_prop { CTL_patent_country } \l_keys_choice_tl } ,
    entrytypeid .choices:nn = { true, false }
      { \prop_put:NnV \l__gbt_bst_control_prop { CTL_entry_type_id } \l_keys_choice_tl } ,
    spacebeforetypeid .choices:nn = { true, false }
      { \prop_put:NnV \l__gbt_bst_control_prop { CTL_space_before_type_id } \l_keys_choice_tl } ,
    entrymediumid .choices:nn = { true, false }
      { \prop_put:NnV \l__gbt_bst_control_prop { CTL_entry_medium_id } \l_keys_choice_tl } ,
  }

\AtBeginDocument
  {
    \prop_if_empty:NF \l__gbt_bst_control_prop
      {
        \iow_new:N \l__gbt_bst_control_iow
        \iow_open:Nn \l__gbt_bst_control_iow { \jobname -BSTcontrol.bib }
        \iow_now:Ne \l__gbt_bst_control_iow
          { @GBT7714BSTCTL \c_left_brace_str GBT7714:BSTcontrol, }
        \prop_map_inline:Nn \l__gbt_bst_control_prop
          {
            \iow_now:Ne \l__gbt_bst_control_iow
              { \c_space_tl \c_space_tl #1 \c_space_tl = \c_space_tl {#2} , }
          }
        \iow_now:Ne \l__gbt_bst_control_iow { \c_right_brace_str }
        \iow_close:N \l__gbt_bst_control_iow
        \nocite { GBT7714:BSTcontrol }
        \cs_set:Npn \bibliography #1
          {
            \if@filesw
              \immediate \write \@auxout
                { \string \bibdata { \jobname -BSTcontrol , \zap@space #1 ~ \@empty } }
            \fi
            \@input@ { \jobname .bbl }
          }
      }
  }

\ExplSyntaxOff

% 控制引注的页码在括号内还是在括号外。
\DeclareKeys[gbt7714]{
  locator-inside-brackets .if = @gbt@locator@inside@affixes ,
}
\SetKeys[gbt7714]{
  locator-inside-brackets = false ,
}

% 将选项传递给 \pkg{natbib}
\DeclareUnknownKeyHandler[gbt7714]{\PassOptionsToPackage{#1}{natbib}}
\ProcessKeyOptions[gbt7714]

% 调用宏包，注意只需要 \opt{compress} 不需要 \opt{sort}。
\RequirePackage{natbib}
\RequirePackage{url}

% 如果将 \opt{compress} 传给 \pkg{natbib} 容易导致 option clash。
% 这里直接修改内部命令。
\def\NAT@cmprs{\@ne}

% 定义接口切换引用文献的标注法，可用 \cs{citestyle} 调用 \opt{numerical}
% 或 \opt{authoryear}，参见 \pkg{natbib}。
\renewcommand\newblock{\space}
\newcommand\bibstyle@super{\bibpunct{[}{]}{,}{s}{,}{\textsuperscript{,}}}
\newcommand\bibstyle@numbers{\bibpunct{[}{]}{,}{n}{,}{,}}
\newcommand\bibstyle@authoryear{\bibpunct{(}{)}{;}{a}{,}{,}}
\newcommand\bibstyle@inline{\bibstyle@numbers}

% 在使用 \cs{bibliographystyle} 时自动切换引用文献的标注的样式。
\@namedef{bibstyle@gbt7714-numerical}{\bibstyle@super}
\@namedef{bibstyle@gbt7714-author-year}{\bibstyle@authoryear}
\@namedef{bibstyle@gbt7714-2005-numerical}{\bibstyle@super}
\@namedef{bibstyle@gbt7714-2005-author-year}{\bibstyle@authoryear}

% 下面修改 \pkg{natbib} 的引用格式。
% 为了减少依赖的宏包，这里直接重定义命令不使用 \pkg{etoolbox} 的 \cs{patchcmd}。

% Super 样式的 \cs{citep} 的页码也为上标。
% 另外加上 |\kern\p@| 去掉上标式引用后与中文之间多余的空格，
% 参考 \href{https://github.com/tuna/thuthesis/issues/624}{tuna/thuthesis\#624}。
\renewcommand\NAT@citesuper[3]{%
  \ifNAT@swa
    \if*#2*\else
      #2\NAT@spacechar
    \fi
    \unskip\kern\p@
    \textsuperscript{%
      \NAT@@open
      #1%
      \if@gbt@locator@inside@affixes
        \if*#3*\else
          \NAT@cmt#3%
        \fi
        \NAT@@close
      \else
        \NAT@@close
        \if*#3*\else
          #3%
        \fi
      \fi
    }%
    \kern\p@
  \else
    #1%
  \fi
  \endgroup
}

% 将 numbers 样式的 \cs{citep} 的页码置于括号外。
\renewcommand\NAT@citenum[3]{%
  \ifNAT@swa
    \NAT@@open
    \if*#2*\else
      #2\NAT@spacechar
    \fi
    #1%
    \if@gbt@locator@inside@affixes
      \if*#3*\else\NAT@cmt#3\fi\NAT@@close
    \else
      \NAT@@close
      \if*#3*\else
        \textsuperscript{#3}%
      \fi
    \fi
  \else
    #1%
  \fi
  \endgroup
}

% Numerical 模式的 \cs{citet} 的页码：
\def\NAT@citexnum[#1][#2]#3{%
  \NAT@reset@parser
  \NAT@sort@cites{#3}%
  \NAT@reset@citea
  \@cite{\def\NAT@num{-1}\let\NAT@last@yr\relax\let\NAT@nm\@empty
    \@for\@citeb:=\NAT@cite@list\do
    {\@safe@activestrue
     \edef\@citeb{\expandafter\@firstofone\@citeb\@empty}%
     \@safe@activesfalse
     \@ifundefined{b@\@citeb\@extra@b@citeb}{%
       {\reset@font\bfseries?}
        \NAT@citeundefined\PackageWarning{natbib}%
       {Citation `\@citeb' on page \thepage \space undefined}}%
     {\let\NAT@last@num\NAT@num\let\NAT@last@nm\NAT@nm
      \NAT@parse{\@citeb}%
      \ifNAT@longnames\@ifundefined{bv@\@citeb\@extra@b@citeb}{%
        \let\NAT@name=\NAT@all@names
        \global\@namedef{bv@\@citeb\@extra@b@citeb}{}}{}%
      \fi
      \ifNAT@full\let\NAT@nm\NAT@all@names\else
        \let\NAT@nm\NAT@name\fi
      \ifNAT@swa
       \@ifnum{\NAT@ctype>\@ne}{%
        \@citea
        \NAT@hyper@{\@ifnum{\NAT@ctype=\tw@}{\NAT@test{\NAT@ctype}}{\NAT@alias}}%
       }{%
        \@ifnum{\NAT@cmprs>\z@}{%
         \NAT@ifcat@num\NAT@num
          {\let\NAT@nm=\NAT@num}%
          {\def\NAT@nm{-2}}%
         \NAT@ifcat@num\NAT@last@num
          {\@tempcnta=\NAT@last@num\relax}%
          {\@tempcnta\m@ne}%
         \@ifnum{\NAT@nm=\@tempcnta}{%
          \@ifnum{\NAT@merge>\@ne}{}{\NAT@last@yr@mbox}%
         }{%
           \advance\@tempcnta by\@ne
           \@ifnum{\NAT@nm=\@tempcnta}{%
%
% 在顺序编码制下，\pkg{natbib} 只有在三个以上连续文献引用才会使用连接号，
% 这里修改为允许两个引用使用连接号。
% 参考 \url{https://tex.stackexchange.com/a/86991/82731}。
             % \ifx\NAT@last@yr\relax
             %   \def@NAT@last@yr{\@citea}%
             % \else
             %   \def@NAT@last@yr{--\NAT@penalty}%
             % \fi
             \def@NAT@last@yr{-\NAT@penalty}%
           }{%
             \NAT@last@yr@mbox
           }%
         }%
        }{%
         \@tempswatrue
         \@ifnum{\NAT@merge>\@ne}{\@ifnum{\NAT@last@num=\NAT@num\relax}{\@tempswafalse}{}}{}%
         \if@tempswa\NAT@citea@mbox\fi
        }%
       }%
       \NAT@def@citea
      \else
        \ifcase\NAT@ctype
          \ifx\NAT@last@nm\NAT@nm \NAT@yrsep\NAT@penalty\NAT@space\else
            \@citea \NAT@test{\@ne}\NAT@spacechar\NAT@mbox{\NAT@super@kern\NAT@@open}%
          \fi
          \if*#1*\else#1\NAT@spacechar\fi
          \NAT@mbox{\NAT@hyper@{{\citenumfont{\NAT@num}}}}%
          \NAT@def@citea@box
        \or
          \NAT@hyper@citea@space{\NAT@test{\NAT@ctype}}%
        \or
          \NAT@hyper@citea@space{\NAT@test{\NAT@ctype}}%
        \or
          \NAT@hyper@citea@space\NAT@alias
        \fi
      \fi
     }%
    }%
      \@ifnum{\NAT@cmprs>\z@}{\NAT@last@yr}{}%
      \ifNAT@swa\else
%
% 将页码放在括号外边，并且置于上标。
        \if@gbt@locator@inside@affixes
          \@ifnum{\NAT@ctype=\z@}{%
            \if*#2*\else\NAT@cmt#2\fi
          }{}%
          \NAT@mbox{\NAT@@close}%
        \else
          \NAT@mbox{\NAT@@close}%
          \@ifnum{\NAT@ctype=\z@}{%
            \if*#2*\else
              \textsuperscript{#2}%
            \fi
          }{}%
          \NAT@super@kern
        \fi
      \fi
  }{#1}{#2}%
}%

% Author-year 模式的 \cs{citep} 的页码：
\renewcommand\NAT@cite%
    [3]{\ifNAT@swa\NAT@@open\if*#2*\else#2\NAT@spacechar\fi
        #1%
        \if@gbt@locator@inside@affixes
          \if*#3*\else\NAT@cmt#3\fi\NAT@@close
        \else
          \NAT@@close\if*#3*\else\textsuperscript{#3}\fi
        \fi
        \else#1\fi\endgroup}

% Author-year 模式的 \cs{citet} 的页码：
\def\NAT@citex%
  [#1][#2]#3{%
  \NAT@reset@parser
  \NAT@sort@cites{#3}%
  \NAT@reset@citea
  \@cite{\let\NAT@nm\@empty\let\NAT@year\@empty
    \@for\@citeb:=\NAT@cite@list\do
    {\@safe@activestrue
     \edef\@citeb{\expandafter\@firstofone\@citeb\@empty}%
     \@safe@activesfalse
     \@ifundefined{b@\@citeb\@extra@b@citeb}{\@citea%
       {\reset@font\bfseries ?}\NAT@citeundefined
                 \PackageWarning{natbib}%
       {Citation `\@citeb' on page \thepage \space undefined}\def\NAT@date{}}%
     {\let\NAT@last@nm=\NAT@nm\let\NAT@last@yr=\NAT@year
      \NAT@parse{\@citeb}%
      \ifNAT@longnames\@ifundefined{bv@\@citeb\@extra@b@citeb}{%
        \let\NAT@name=\NAT@all@names
        \global\@namedef{bv@\@citeb\@extra@b@citeb}{}}{}%
      \fi
     \ifNAT@full\let\NAT@nm\NAT@all@names\else
       \let\NAT@nm\NAT@name\fi
     \ifNAT@swa\ifcase\NAT@ctype
       \if\relax\NAT@date\relax
         \@citea\NAT@hyper@{\NAT@nmfmt{\NAT@nm}\NAT@date}%
       \else
         \ifx\NAT@last@nm\NAT@nm\NAT@yrsep
            \ifx\NAT@last@yr\NAT@year
              \def\NAT@temp{{?}}%
              \ifx\NAT@temp\NAT@exlab\PackageWarningNoLine{natbib}%
               {Multiple citation on page \thepage: same authors and
               year\MessageBreak without distinguishing extra
               letter,\MessageBreak appears as question mark}\fi
              \NAT@hyper@{\NAT@exlab}%
            \else\unskip\NAT@spacechar
              \NAT@hyper@{\NAT@date}%
            \fi
         \else
           \@citea\NAT@hyper@{%
             \NAT@nmfmt{\NAT@nm}%
             \hyper@natlinkbreak{%
               \NAT@aysep\NAT@spacechar}{\@citeb\@extra@b@citeb
             }%
             \NAT@date
           }%
         \fi
       \fi
     \or\@citea\NAT@hyper@{\NAT@nmfmt{\NAT@nm}}%
     \or\@citea\NAT@hyper@{\NAT@date}%
     \or\@citea\NAT@hyper@{\NAT@alias}%
     \fi \NAT@def@citea
     \else
       \ifcase\NAT@ctype
        \if\relax\NAT@date\relax
          \@citea\NAT@hyper@{\NAT@nmfmt{\NAT@nm}}%
        \else
         \ifx\NAT@last@nm\NAT@nm\NAT@yrsep
            \ifx\NAT@last@yr\NAT@year
              \def\NAT@temp{{?}}%
              \ifx\NAT@temp\NAT@exlab\PackageWarningNoLine{natbib}%
               {Multiple citation on page \thepage: same authors and
               year\MessageBreak without distinguishing extra
               letter,\MessageBreak appears as question mark}\fi
              \NAT@hyper@{\NAT@exlab}%
            \else
              \unskip\NAT@spacechar
              \NAT@hyper@{\NAT@date}%
            \fi
         \else
           \@citea\NAT@hyper@{%
             \NAT@nmfmt{\NAT@nm}%
             \hyper@natlinkbreak{\NAT@spacechar\NAT@@open\if*#1*\else#1\NAT@spacechar\fi}%
               {\@citeb\@extra@b@citeb}%
             \NAT@date
           }%
         \fi
        \fi
       \or\@citea\NAT@hyper@{\NAT@nmfmt{\NAT@nm}}%
       \or\@citea\NAT@hyper@{\NAT@date}%
       \or\@citea\NAT@hyper@{\NAT@alias}%
       \fi
       \if\relax\NAT@date\relax
         \NAT@def@citea
       \else
         \NAT@def@citea@close
       \fi
     \fi
     }}\ifNAT@swa\else
%
% 将页码放在括号外边，并且置于上标。
       \if@gbt@locator@inside@affixes
         \if*#2*\else\NAT@cmt#2\fi
         \if\relax\NAT@date\relax\else\NAT@@close\fi
       \else
         \if\relax\NAT@date\relax\else\NAT@@close\fi
         \if*#2*\else\textsuperscript{#2}\fi
       \fi
     \fi}{#1}{#2}}

% 参考文献列表的标签左对齐
\renewcommand\@biblabel[1]{[#1]\hfill}

% Patch \pkg{natbib} 内部命令，以支持 \cs{noopsort}。
% 参考 \url{https://tex.stackexchange.com/a/39718/82731}。
\let\NAT@bare@aux\NAT@bare
\def\NAT@bare#1(#2){%
 \begingroup\edef\x{\endgroup
   \unexpanded{\NAT@bare@aux#1}(\@firstofone#2)}\x}

% 使用 \pkg{xurl} 宏包的方法，增加 URL 可断行的位置。
\g@addto@macro\UrlBreaks{%
  \do0\do1\do2\do3\do4\do5\do6\do7\do8\do9%
  \do\A\do\B\do\C\do\D\do\E\do\F\do\G\do\H\do\I\do\J\do\K\do\L\do\M
  \do\N\do\O\do\P\do\Q\do\R\do\S\do\T\do\U\do\V\do\W\do\X\do\Y\do\Z
  \do\a\do\b\do\c\do\d\do\e\do\f\do\g\do\h\do\i\do\j\do\k\do\l\do\m
  \do\n\do\o\do\p\do\q\do\r\do\s\do\t\do\u\do\v\do\w\do\x\do\y\do\z
}
\Urlmuskip=0mu plus 0.1mu

% 兼容 v2.0 前过时的接口：
\newif\ifgbt@bib@style@written
\@ifpackageloaded{chapterbib}{}{%
  \def\bibliography#1{%
    \ifgbt@bib@style@written\else
      \bibliographystyle{gbt7714-numerical}%
    \fi
    \if@filesw
      \immediate\write\@auxout{\string\bibdata{\zap@space#1 \@empty}}%
    \fi
    \@input@{\jobname.bbl}}
  \def\bibliographystyle#1{%
    \gbt@bib@style@writtentrue
    \ifx\@begindocumenthook\@undefined\else
      \expandafter\AtBeginDocument
    \fi
      {\if@filesw
        \immediate\write\@auxout{\string\bibstyle{#1}}%
      \fi}%
  }%
}
\ifgbt@legacy@interface
  \ifgbt@numerical
    \ifgbt@super\else
      \citestyle{numbers}
    \fi
    \bibliographystyle{gbt7714-numerical}
  \else
    \bibliographystyle{gbt7714-author-year}
  \fi
\fi
